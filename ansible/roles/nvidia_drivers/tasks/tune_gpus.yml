---
- name: Enable GPU persistence mode
  become: true
  command: nvidia-smi -pm 1
  changed_when: false

- name: Set GPU to EXCLUSIVE_PROCESS mode (Slurm manages GPU allocation)
  become: true
  command: nvidia-smi -c 3
  changed_when: false

- name: Lock GPU clocks to max frequency (A100 = 1410 MHz)
  become: true
  command: nvidia-smi -lgc 1410
  changed_when: false
  failed_when: false

- name: Set GPU power limit to TDP (400W for A100 40GB)
  become: true
  command: nvidia-smi -pl 400
  changed_when: false
  failed_when: false

- name: Disable auto-boost for consistent clock speeds
  become: true
  command: nvidia-smi --auto-boost-default=0
  changed_when: false
  failed_when: false

- name: Verify ECC memory is enabled
  become: true
  command: nvidia-smi --ecc-config=1
  changed_when: false
  failed_when: false
